extends ../../layout

block content
  - var totalDays = Math.floor(moment(target.end).diff(moment(target.start), 'days', true)) + 1

  h1= title
  
  .row: .col-sm-12: .panel.panel-primary
    .panel-heading: h2.panel-title Target progress
    .panel-body
      h3.text-center= target.name
      #chart
      .text-center
        button#target-change.btn.btn-default(type='button') Show as daily writing
  
  .row
    .col-sm-2.text-right
      strong Name:
    .col-sm-10
      = target.name
      
  .row
    .col-sm-2.text-right
      strong Start:
    .col-sm-10
      = moment(target.start).format('YYYY-MM-DD')
 
  .row
    .col-sm-2.text-right
      strong End:
    .col-sm-10
      = moment(target.end).format('YYYY-MM-DD')
      
  .row
    .col-sm-2.text-right
      strong Target wordcount:
    .col-sm-10
      = target.wordcount
      
  .row
    .col-sm-2.text-right
      strong Notes:
    .col-sm-10
      - var notePieces = target.notes.split(/(?:\r\n|\r|\n)/g)
      for line, i in notePieces
        if i > 0
          br
        = line
  
  - var allSessions = []
  .row
    .col-sm-2.text-right
      strong Projects:
    .col-sm-10
      ul
        for project in target.projects
          - allSessions = allSessions.concat(project.sessions)
          li
            a(href='/projects/' + project.id title='View project ' + project.name)= project.name
            | &nbsp;(
            if project.sessions.length == 0
              | No session in this project within this target's period
            else
              for session,i in project.sessions.slice(0, 3)
                if i > 0
                  | ,&nbsp;
                - var sessionName = (session.summary) || (moment(session.start).format('YYYY-MM-DD HH:mm:ss'))
                a(href='/sessions/' + session.id title='View session ' + sessionName)= sessionName
            | ,&nbsp;
            a(href='/sessions?projectid=' + project.id title='All sessions for this project') ...
            | )
  
  .row
    .col-sm-2.text-right: strong Target count per day:
    .col-sm-10= Math.ceil(target.wordcount / totalDays)
      | &nbsp;words
        
  .row
    .col-sm-2.text-right: strong Words per day #{totalDays}
    .col-sm-10: ul
      for sessions, day in _.groupBy(allSessions, function(sess) { return moment(sess.dataValues.start).format('YYYY-MM-DD') })
        - console.log(day, session)
        li
          strong= day
          | :&nbsp;
          = _.reduce(sessions, function(wc, sess) { return wc + sess.dataValues.wordcount }, 0)
          

append styles
  link(rel='stylesheet', href='/bower_components/c3/c3.min.css')
  link(rel='stylesheet', href='/stylesheets/chart.css')

append scripts  
  script(type='text/javascript', src='/bower_components/d3/d3.min.js')
  script(type='text/javascript', src='/bower_components/c3/c3.min.js')
  script(type='text/javascript', src='/scripts/chart.js')    
  script(type='text/javascript').
    buildChart(!{target.id}, jQuery, c3, d3);
